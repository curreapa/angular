SELECT YEAR( `vp`.`dt_fecha` ) `anio`, MONTH( `vp`.`dt_fecha` ) `mes`, `s`.`s_nombreFantasia` `sucursal`, `up`.`s_nombrePila` `vendedor`, COUNT( DISTINCT `vdp`.`mi_numeroVenta` ) `numeroVentas`, ROUND( SUM( `vdp`.`dc_montoBruto` ) ) `montoBrutoVentas`, ROUND( SUM( `vdp`.`dc_contribucionIncentivo` ) ) `contribucionVentasDescontadoInc`, ROUND( SUM( `vdp`.`dc_contribucionIncentivo` ) / SUM( `vdp`.`dc_montoNeto` ), 4 ) `margenVentasDescontadoInc`, COUNT( `vdp`.`si_idSucursal` ) `numeroProductos`, SUM( `vdp`.`i_cantidad` ) `unidadesTotalesVendidas`, IFNULL( `incentivos`.`productosConIncentivos`, 0 ) `unidadesConIncentivo`, IFNULL( ROUND( `incentivos`.`productosConIncentivos` / SUM( `vdp`.`i_cantidad` ), 2 ), 0 ) `efectividad`, ROUND( SUM( `vdp`.`i_cantidad` ) / COUNT( DISTINCT `vdp`.`mi_numeroVenta` ), 2 ) `promUndXventa`, ROUND( ROUND( SUM( `vdp`.`dc_montoBruto` ) ) / COUNT( DISTINCT `vdp`.`mi_numeroVenta` ) ) `montoVentaPromedio` FROM `dbecosur`.`tbl_producto` `p` INNER JOIN `dbecosur`.`tbl_codigoBarras` `cb` ON `p`.`i_idProducto` = `cb`.`i_idProducto` INNER JOIN `dbecosur`.`tbl_ventaDetallePOS` `vdp` ON `vdp`.`s_codigoBarra` = `cb`.`s_codigoBarra` INNER JOIN `dbecosur`.`tbl_ventaPOS` `vp` ON `vdp`.`si_idSucursal` = `vp`.`si_idSucursal` AND `vdp`.`si_numeroCaja` = `vp`.`si_numeroCaja` AND `vdp`.`mi_numeroVenta` = `vp`.`mi_numeroVenta` INNER JOIN `dbecosur`.`tbl_sucursal` `s` ON `vp`.`si_idSucursal` = `s`.`si_idSucursal` INNER JOIN `dbecosur`.`tbl_usuarioPOS` `up` ON `vp`.`si_numeroUsuario` = `up`.`si_numeroUsuario` AND `up`.`si_idSucursal` = `vp`.`si_idSucursal` LEFT JOIN ( SELECT YEAR( `vp`.`dt_fecha` ) `a単o`, MONTH( `vp`.`dt_fecha` ) `mes`, `s`.`s_nombreFantasia` `sucursal`, `up`.`si_numeroUsuario` `idVendedor`, `up`.`s_nombrePila` `vendedor`, ( SUM( `vdp`.`i_cantidad` ) ) `productosConIncentivos` FROM `dbecosur`.`tbl_ventaDetallePOS` `vdp` INNER JOIN `dbecosur`.`tbl_ventaPOS` `vp` ON `vdp`.`si_idSucursal` = `vp`.`si_idSucursal` AND `vdp`.`si_numeroCaja` = `vp`.`si_numeroCaja` AND `vdp`.`mi_numeroVenta` = `vp`.`mi_numeroVenta` INNER JOIN `dbecosur`.`tbl_usuarioPOS` `up` ON `vp`.`si_numeroUsuario` = `up`.`si_numeroUsuario` AND `up`.`si_idSucursal` = `vp`.`si_idSucursal` INNER JOIN `dbecosur`.`tbl_sucursal` `s` ON `vp`.`si_idSucursal` = `s`.`si_idSucursal` WHERE `vp`.`dt_fecha` BETWEEN '2021-01-01' AND '2021-12-31' AND `vp`.`si_idSucursal` = 4 AND `vdp`.`dc_incentivo` > 0 GROUP BY `a単o`, `mes`, `sucursal`, `idVendedor` ) `incentivos` ON `incentivos`.`a単o` = YEAR( `vp`.`dt_fecha` ) AND `incentivos`.`mes` = MONTH( `vp`.`dt_fecha` ) AND `incentivos`.`sucursal` = `s`.`s_nombreFantasia` AND `incentivos`.`idVendedor` = `up`.`si_numeroUsuario` WHERE `vp`.`dt_fecha` BETWEEN '2021-01-01' AND '2021-12-31' AND `vp`.`si_idSucursal` = 4 GROUP BY `a単o`, `mes`, `sucursal`, `idVendedor`